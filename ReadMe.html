<!DOCTYPE html>
    <html>
    <head>
        <meta http-equiv="Content-type" content="text/html;charset=UTF-8">
        <title>Integra 85 Focusing Rotator from [Gemini Telescope Design][gtd]</title>
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.10.0-rc.1/dist/katex.min.css" integrity="sha384-D+9gmBxUQogRLqvARvNLmA9hS2x//eK1FhVb9PiU86gmcrBrJAQT8okdJ4LMp2uv" crossorigin="anonymous">
        <style>
/*--------------------------------------------------------------------------------------------- * Copyright (c) Microsoft Corporation. All rights reserved. * Licensed under the MIT License. See License.txt in the project root for license information. *--------------------------------------------------------------------------------------------*/ body { font-family: "Segoe WPC", "Segoe UI", "SFUIText-Light", "HelveticaNeue-Light", sans-serif, "Droid Sans Fallback"; font-size: 14px; padding: 0 26px; line-height: 22px; word-wrap: break-word; } #code-csp-warning { position: fixed; top: 0; right: 0; color: white; margin: 16px; text-align: center; font-size: 12px; font-family: sans-serif; background-color:#444444; cursor: pointer; padding: 6px; box-shadow: 1px 1px 1px rgba(0,0,0,.25); } #code-csp-warning:hover { text-decoration: none; background-color:#007acc; box-shadow: 2px 2px 2px rgba(0,0,0,.25); } body.scrollBeyondLastLine { margin-bottom: calc(100vh - 22px); } body.showEditorSelection .code-line { position: relative; } body.showEditorSelection .code-active-line:before, body.showEditorSelection .code-line:hover:before { content: ""; display: block; position: absolute; top: 0; left: -12px; height: 100%; } body.showEditorSelection li.code-active-line:before, body.showEditorSelection li.code-line:hover:before { left: -30px; } .vscode-light.showEditorSelection .code-active-line:before { border-left: 3px solid rgba(0, 0, 0, 0.15); } .vscode-light.showEditorSelection .code-line:hover:before { border-left: 3px solid rgba(0, 0, 0, 0.40); } .vscode-light.showEditorSelection .code-line .code-line:hover:before { border-left: none; } .vscode-dark.showEditorSelection .code-active-line:before { border-left: 3px solid rgba(255, 255, 255, 0.4); } .vscode-dark.showEditorSelection .code-line:hover:before { border-left: 3px solid rgba(255, 255, 255, 0.60); } .vscode-dark.showEditorSelection .code-line .code-line:hover:before { border-left: none; } .vscode-high-contrast.showEditorSelection .code-active-line:before { border-left: 3px solid rgba(255, 160, 0, 0.7); } .vscode-high-contrast.showEditorSelection .code-line:hover:before { border-left: 3px solid rgba(255, 160, 0, 1); } .vscode-high-contrast.showEditorSelection .code-line .code-line:hover:before { border-left: none; } img { max-width: 100%; max-height: 100%; } a { text-decoration: none; } a:hover { text-decoration: underline; } a:focus, input:focus, select:focus, textarea:focus { outline: 1px solid -webkit-focus-ring-color; outline-offset: -1px; } hr { border: 0; height: 2px; border-bottom: 2px solid; } h1 { padding-bottom: 0.3em; line-height: 1.2; border-bottom-width: 1px; border-bottom-style: solid; } h1, h2, h3 { font-weight: normal; } h1 code, h2 code, h3 code, h4 code, h5 code, h6 code { font-size: inherit; line-height: auto; } table { border-collapse: collapse; } table > thead > tr > th { text-align: left; border-bottom: 1px solid; } table > thead > tr > th, table > thead > tr > td, table > tbody > tr > th, table > tbody > tr > td { padding: 5px 10px; } table > tbody > tr + tr > td { border-top: 1px solid; } blockquote { margin: 0 7px 0 5px; padding: 0 16px 0 10px; border-left-width: 5px; border-left-style: solid; } code { font-family: Menlo, Monaco, Consolas, "Droid Sans Mono", "Courier New", monospace, "Droid Sans Fallback"; font-size: 14px; line-height: 19px; } body.wordWrap pre { white-space: pre-wrap; } .mac code { font-size: 12px; line-height: 18px; } pre:not(.hljs), pre.hljs code > div { padding: 16px; border-radius: 3px; overflow: auto; } /** Theming */ pre code { color: var(--vscode-editor-foreground); } .vscode-light pre { background-color: rgba(220, 220, 220, 0.4); } .vscode-dark pre { background-color: rgba(10, 10, 10, 0.4); } .vscode-high-contrast pre { background-color: rgb(0, 0, 0); } .vscode-high-contrast h1 { border-color: rgb(0, 0, 0); } .vscode-light table > thead > tr > th { border-color: rgba(0, 0, 0, 0.69); } .vscode-dark table > thead > tr > th { border-color: rgba(255, 255, 255, 0.69); } .vscode-light h1, .vscode-light hr, .vscode-light table > tbody > tr + tr > td { border-color: rgba(0, 0, 0, 0.18); } .vscode-dark h1, .vscode-dark hr, .vscode-dark table > tbody > tr + tr > td { border-color: rgba(255, 255, 255, 0.18); } 
</style>
<style>
/* https://raw.githubusercontent.com/isagalaev/highlight.js/master/src/styles/vs2015.css */ /* * Visual Studio 2015 dark style * Author: Nicolas LLOBERA <nllobera@gmail.com> */ .hljs-keyword, .hljs-literal, .hljs-symbol, .hljs-name { color: #569CD6; } .hljs-link { color: #569CD6; text-decoration: underline; } .hljs-built_in, .hljs-type { color: #4EC9B0; } .hljs-number, .hljs-class { color: #B8D7A3; } .hljs-string, .hljs-meta-string { color: #D69D85; } .hljs-regexp, .hljs-template-tag { color: #9A5334; } .hljs-subst, .hljs-function, .hljs-title, .hljs-params, .hljs-formula { color: #DCDCDC; } .hljs-comment, .hljs-quote { color: #57A64A; font-style: italic; } .hljs-doctag { color: #608B4E; } .hljs-meta, .hljs-meta-keyword, .hljs-tag { color: #9B9B9B; } .hljs-variable, .hljs-template-variable { color: #BD63C5; } .hljs-attr, .hljs-attribute, .hljs-builtin-name { color: #9CDCFE; } .hljs-section { color: gold; } .hljs-emphasis { font-style: italic; } .hljs-strong { font-weight: bold; } /*.hljs-code { font-family:'Monospace'; }*/ .hljs-bullet, .hljs-selector-tag, .hljs-selector-id, .hljs-selector-class, .hljs-selector-attr, .hljs-selector-pseudo { color: #D7BA7D; } .hljs-addition { background-color: #144212; display: inline-block; width: 100%; } .hljs-deletion { background-color: #600; display: inline-block; width: 100%; } /* From https://raw.githubusercontent.com/isagalaev/highlight.js/master/src/styles/vs.css */ /* Visual Studio-like style based on original C# coloring by Jason Diamond <jason@diamond.name> */ .vscode-light .hljs-function, .vscode-light .hljs-params { color: inherit; } .vscode-light .hljs-comment, .vscode-light .hljs-quote, .vscode-light .hljs-variable { color: #008000; } .vscode-light .hljs-keyword, .vscode-light .hljs-selector-tag, .vscode-light .hljs-built_in, .vscode-light .hljs-name, .vscode-light .hljs-tag { color: #00f; } .vscode-light .hljs-string, .vscode-light .hljs-title, .vscode-light .hljs-section, .vscode-light .hljs-attribute, .vscode-light .hljs-literal, .vscode-light .hljs-template-tag, .vscode-light .hljs-template-variable, .vscode-light .hljs-type, .vscode-light .hljs-addition { color: #a31515; } .vscode-light .hljs-deletion, .vscode-light .hljs-selector-attr, .vscode-light .hljs-selector-pseudo, .vscode-light .hljs-meta { color: #2b91af; } .vscode-light .hljs-doctag { color: #808080; } .vscode-light .hljs-attr { color: #f00; } .vscode-light .hljs-symbol, .vscode-light .hljs-bullet, .vscode-light .hljs-link { color: #00b0e8; } .vscode-light .hljs-emphasis { font-style: italic; } .vscode-light .hljs-strong { font-weight: bold; }
</style>
<style>
.task-list-item { list-style-type: none; } .task-list-item-checkbox { margin-left: -20px; vertical-align: middle; }
</style>
        <style>
            body {
                font-family: -apple-system, BlinkMacSystemFont, 'Segoe WPC', 'Segoe UI', 'HelveticaNeue-Light', 'Ubuntu', 'Droid Sans', sans-serif;
                font-size: 14px;
                line-height: 1.6;
            }
        </style>
        
    </head>
    <body>
        <h1 id="integra-85-focusing-rotator-from-gemini-telescope-design">Integra 85 Focusing Rotator from <a href="http://www.geminitelescope.com/" title="Gemini Telescope Design">Gemini Telescope Design</a></h1>
<p>Firmware coded by Tim Long of <a href="http://tigra-astronomy.com" title="Tigra Astronomy">Tigra Astronomy</a></p>
<h2 id="design-philosophy">Design Philosophy</h2>
<p>Within the limitations of the Arduino Uno (a resource-constrained embedded system),
we have tried to apply the SOLID principles of object oriented design:</p>
<p>S - Single responsibility principle; each class should have only one responsibility
O - Open/Closed principle; open for extension, closed for modification
L - Liskov substitution principle; superclasses and subclasses classes should be interchangeable
I - Interface segregation principle; no client should be forced to depend on methods it does not use
D - Dependency inversion principle: depend on abstractions not details.</p>
<p>Well-factored object oriented code that adheres to the SOLID principles should be loosely coupled,
highly cohesive, testable and have low viscosity for future maintenance.</p>
<p>Due to resource constraints imposed by the target hardware, we have had to refactor some of the code
into a more procedural style in order to save memory.</p>
<h2 id="memory-management">Memory Management</h2>
<p>Dynamic memory allocations have been agressively avoided. As a
resource-constrained embedded system with just 2Kb of data memory, there is not
much space available for a heap and we can't tolerate &quot;Out Of Memory&quot; errors
at runtime. The system must be stable for days, months or even years at a time
so the memory management strategy must be frugal, deterministic and stable.</p>
<p>Our solution to this is to statically pre-allocate as many objects as possible once,
in global scope, then never delete them. The top level <code>.ino</code> file contains these allocations
either as statically initialized global variables or in the setup() method and this
essentially forms the Composition Root for the system.</p>
<p>Since we can assume that most objects are never freed, there is little to be gained
from the use of smart pointers and we have chosen to avoid the overhead and use &quot;raw&quot; pointers
where necessary. We do however make use of the <code>std::vector&lt;T&gt;</code> class to manage collections
of pointers.</p>
<h2 id="motor-control">Motor Control</h2>
<p>The two stepper motors have a Direction/Step/Enable interface and are driven by generating
a square wave onto the Step pin. The process is logically devided into two parts:</p>
<h3 id="step-generator">Step Generator</h3>
<p>A step generator (implements: <code>IStepGenerator</code>) is responsible for generating a pulse train
where each rising edge causes the motor to make one step. The step generator is responsible
for timing (step speed) and has no concept of position, direction or the type of steps (whole
steps, microsteps, etc.)</p>
<p>We have provided a single implementation, <code>CounterTimer1StepGenerator</code>, which uses the Timer 1
block of the AVR processor to generate accurately timed pulses with 50% duty cycle.
The timer is configured to generate interrupts using the <code>OCR1A</code> compare register. The timing
source is the undivided system clock, which allows for a theoretical stepping bandwidth of about
244 steps/second up to 16,000,000 steps/second.</p>
<h3 id="step-sequencer">Step Sequencer</h3>
<p>The step sequencer (implements: <code>IStepSequencer</code>) carries the responsibility of writing the correct
hardware signals to the motor driver and keeping track of the step position.</p>
<p>Our <code>Motor</code> class provides the <code>IStepSequencer</code> implementation and allows for acceleration
and deceleration. <code>Motor</code> also keeps track of the current step position and enforces limits
of travel on the motors.</p>
<p>Derived from <code>Motor</code> is <code>BacklashCompensatingMotor</code> which performs backlash compensation by adding the backlash amount whenever the motor direction changes. This process is hidden from the client. Thus, if backlash is measured to be 100 steps, the last move was outwards and the client requests a move inwards of 1000 steps, then the reported position will decrease by 1000 but the motor will actually move 1,100 steps.</p>
<h3 id="acceleration">Acceleration</h3>
<p>The <code>Motor</code> class implements acceleration and deceleration based on the equation of
uniform acceleration, v = u + at. This reduces the risk of stalling, especially when
moving heavy loads.</p>
<p>The <code>ComputeAcceleratedVelocity</code> method is called once per Arduino main loop
to recompute the motor velocity and acceleration curves.</p>
<p>The &quot;Ramp Time&quot; (the time taken to accelerate from rest to maximum speed)
is configurable by the user. Ramp time is specified in milliseconds.
250 to 500 milliseconds is usually sufficient for moderate loads but for
more massive loads this can be increased.</p>
<h3 id="speed-and-power-considerations">Speed and Power Considerations</h3>
<p>The Integra 85 uses a worm and worm wheel gearing arrangement to drive both the focuser
and rotator mechanism. This arrangement provides a naturally stable system at rest
which means that holding torque in the stepper motors is unnecessary. Therefore,  the step
drivers are disabled once motion has ceased. This reduces power consuption and keeps the
motors and step drivers cool when not actively driving the mechanism.</p>
<p>While the firmware is capable of very high step rates, there is a trade-off between
maximum stepping speed, available torque and power consumption. The firmware provides
commands for adjusting maximum step rate (<code>VW</code>) and acceleration ramp time (<code>AW</code>)
so that the end user can manage this speed/torque/power tradeoff.</p>
<p>In practice the motors used in the Integra 85 will perform well up to at least
16,000 microsteps, 1000 whole steps or about 5 revolutions per second when used
with moderate loads.</p>
<p>Beyond that, the motors may be unable to provide sufficient torque and may stall. Therefore
we do not advise increasing the maximum step speed much beyond the default 16,000 microsteps
per second.</p>
<p>For larger loads with higher inertia, it may be desirable to lower the maximum
step rate (<code>VW</code>) and increase the acceleration ramp time (<code>AW</code>).</p>
<h3 id="limitations">Limitations</h3>
<p>In this implementation, all motors share the same <code>IStepGenerator</code> because only one
16-bit counter/timer block is available on the Arduino's AVR processor core.
Therefore only one motor can be in motion at any moment. No gaurds are in place to
prevent misoperation. It is assumed that this will be controlled at a higher level
(probably in the ASCOM driver).</p>
<h2 id="command-processor">Command Processor</h2>
<p>Command processing is handled by the <code>CommandProcessor</code> class.</p>
<p>Originally, we had a nice object oriented design for the command processor but it used one class
for each command and then sometimes multiple instances of each command processor for different devices.
It all took up a bit too much memory for the Arduino Uno, which only has 2 Kb of data memory.
The pattern is recorded in the version control repository and may be useful in future projects
where resources are less constrained.</p>
<p>When a well formed command is received from the communications channel (serial or bluetooth) it is
passed to <code>DispatchCommand()</code> which passes it on to <code>CommandProcessor::HandleCommand()</code>.</p>
<p>Each command verb has its own handler method, so for example, the <code>PR</code> (position read) command
would be handled by <code>CommandProcessor::HandlePR()</code>. <code>CommandProcessor::HandleCommand()</code>
decides which handler method to call based on the command verb.</p>
<p>All command handlers return a <code>Response</code> structure, which contains the text to be transmitted
via the serial port or Bluetooth adapter to the client application.</p>
<h2 id="command-protocol">Command Protocol</h2>
<h3 id="command-grammar">Command Grammar</h3>
<p>Commands have the form: <kbd>@</kbd> <code>Verb</code> <code>Device</code><kbd>,</kbd> <code>Parameter</code> <kbd>&lt;CR&gt;</kbd><kbd>&lt;LF&gt;</kbd>.</p>
<ul>
<li><kbd>@</kbd> is a literal character that marks the start of a new command and clears the receive buffer. Use of the <kbd>@</kbd> initiator is optional, but recommended.</li>
<li><code>Verb</code> is the command verb, which normally consists of two characters. Single character verbs are also possible but in this case the entire command is a single character.</li>
<li><code>Device</code> is the target device for the command, generally a motor number <code>1</code> (focuser) or <code>2</code> (rotator).
Where no device address is given, a default value of <code>0</code> is assumed.</li>
<li><kbd>,</kbd> is a literal character that separates the device ID from the parameter.</li>
<li><code>Parameter</code> is a positive integer. If omitted, zero is assumed.</li>
<li><kbd>RETURN</kbd><kbd>LINE FEED</kbd> is the command terminator and submits the command to the dispatcher.
Only one is required. If both are present then they can be in any order.</li>
</ul>
<p><example>Example: <code>@MI1,1000</code>.</example></p>
<p>If the parameter field is not required for a command, then it can be omitted or, if specified, it will be ignored. For example, the following are all equivalent:
<code>@PR1</code>, <code>@PR1,</code>, <code>@PR1,1000</code></p>
<h3 id="errors">Errors</h3>
<p>Any unrecognised or invalid command responds with the text <code>Err</code>.</p>
<h3 id="command-protocol-details">Command Protocol Details</h3>
<pre>
Command | Reply   | Min  | Max    | Default | Notes
========|=========|======|========|=========|=====================================================
Motor configuration: 1 whole step = 16 microsteps
--------|---------|------|--------|---------|-----------------------------------------------------
AWm,n   | AW#     |    1 |  65535 |     500 | Set the acceleration ramp time in milliseconds
RRm     | RRnnnn# |      |        |         | Reads the range of movement in steps for motor m
RW1,n   | RW#     |    1 | 2^32-1 |  198000 | Sets the limit of travel for the focuser in whole steps
RW2,n   | RW#     |    1 | 2^32-1 |   61802 | Sets the number of whole steps per revolution for the rotator
PRm     | PRnnnn# |      |        |         | Read step position of motor m in whole steps
PWm,n   | PW#     |    0 | RRm    |         | Sync current whole step position. Max value is returned by RRm
VRm     | VRnnnn# |  16  |  65535 |    1000 | Read maximum motor speed in steps/second
VWm,n   | VW#     |  250 |  65535 |    1000 | Write maximum motor speed in steps/second
--------|---------|------|--------|---------|-----------------------------------------------------
Motor movement
--------|---------|------|--------|---------|-----------------------------------------------------
MIm,n   | MI#     |    0 | PRm    |         | Move in or anticlockwise n whole steps
MOm,n   | MO#     |    0 | RRm-PRm|         | Move out or clockwise n whole steps
SWm     | SW#     |      |        |         | Emergency stop (no deceleration)
X       | Xn#     |      |        |         | 0=stopped; 1=focuser moving; 2=rotator moving
--------|---------|------|--------|---------|-----------------------------------------------------
Backlash and calibration commands only valid for focuser (m=1)
--------|---------|------|--------|---------|-----------------------------------------------------
BRm     | BRnnnn# |    0 |        | auto    | Read backlash amount, in whole steps.
BWm,n   | BW#     |    0 | 0.5 RR | auto    | Write backlash amount. Max value is half the limit of travel.
CSm     | CS#     |      |        |         | Start calibration. Measures home position and backlash amount.
CEm     | CE#     |      |        |         | Stops calibration and sets status to Cancelled
CRm     | CRn#    |      |        |         | Returns 0=Uncalibrated; 1=Calibrated; 2=In Progress; 3=Cancelled
CWm,n   | CW#     |    0 |      1 | auto    | Force the calibration state to 0=Uncalibrated; 1=Calibrated
Clm,n   | Cl#     |    1 |   1023 |     300 | Set the touch sensor "first contact" threshold
CLm,n   | CL#     |    1 |   1023 |     600 | Set the touch sensor "hard stop" threshold
Cvm,n   | CV#     |  250 |  65535 |    2880 | Set calibration slow motion motor speed
--------|---------|------|--------|---------|-----------------------------------------------------
System-wide commands
--------|---------|------|--------|---------|-----------------------------------------------------
ER      | ERnnnn# |    0 |   1023 |         | Reads the value of the touch sensor
FR      | FRm.n#  |      |        |         | Reads the firmware version major.minor
TR      | TRnn.n# |      |        |         | Reads the temperature in °C.
ZR      | ZR#     |      |        |         | Loads settings from persistent storage.
ZW      | ZW#     |      |        |         | Writes settings to persistent storage
ZD      | ZD#     |      |        |         | Reset to factory defaults. Erases all saved data.
--------|---------|------|--------|---------|-----------------------------------------------------
</pre>
<p>Note that omitting all of the optional parts of each command gives a more convenient syntax when
entering commands manually in a terminal emulator. The table above gives the shortest possible form
of each command. However, when commands are generated programmatically, it is recommended that the
initial <code>@</code> character is always included.</p>
<h2 id="arduino-libraries-used">Arduino Libraries Used</h2>
<ul>
<li>ArduinoSTL - standard template library</li>
<li>eeprom - for reading and writing the nonvolatile storage</li>
<li>SoftwareSerial - used to access the Bluetooth module</li>
<li>OneWire - used for low-level access to the temperature probe.</li>
<li>DallasTemperature - intermediate level interfacing to the temperature probe</li>
</ul>
<h2 id="revision-notes">Revision Notes</h2>
<h3 id="release-20">Release 2.0</h3>
<p>First version by Tigra Astronomy. Implements almost all of the commands from release 1.0 but with completely re-written firmware.</p>
<h3 id="release-21">Release 2.1</h3>
<p>Added the <code>ER</code> command (Read force-sensitive resistor value). This command was actually implemented
in the previous version but not wired into the command processor, so there was no way to invoke it.</p>

    </body>
    </html>